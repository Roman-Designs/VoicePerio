name: Build Portable USB Bundle

on:
  workflow_dispatch:  # Manual trigger only - click "Run workflow" on GitHub

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download Python Embeddable
        shell: pwsh
        run: |
          $pythonVersion = "3.10.11"
          $url = "https://www.python.org/ftp/python/$pythonVersion/python-$pythonVersion-embed-amd64.zip"
          $outDir = "VoicePerio_Portable"
          
          # Create directory structure
          New-Item -ItemType Directory -Path "$outDir/python" -Force
          New-Item -ItemType Directory -Path "$outDir/app" -Force
          New-Item -ItemType Directory -Path "$outDir/models" -Force
          
          # Download and extract Python Embeddable
          Write-Host "Downloading Python $pythonVersion Embeddable..."
          Invoke-WebRequest -Uri $url -OutFile "python_embed.zip"
          Expand-Archive -Path "python_embed.zip" -DestinationPath "$outDir/python" -Force
          Remove-Item "python_embed.zip"
          
          # Enable site-packages by uncommenting 'import site' in ._pth file
          # Also add the app/src path so 'voiceperio' package is found without PYTHONPATH
          $pthFile = Get-ChildItem "$outDir/python" -Filter "python*._pth" | Select-Object -First 1
          if ($pthFile) {
            $content = (Get-Content $pthFile.FullName) -replace '#import site', 'import site'
            # Add relative path to app/src so the voiceperio package is always discoverable
            $content += "../app/src"
            Set-Content $pthFile.FullName $content
            Write-Host "Enabled site-packages and added app/src in $($pthFile.Name)"
          }

      - name: Install pip in portable Python
        shell: pwsh
        run: |
          $pythonExe = "VoicePerio_Portable/python/python.exe"
          
          # Download and run get-pip.py
          Invoke-WebRequest -Uri "https://bootstrap.pypa.io/get-pip.py" -OutFile "get-pip.py"
          & $pythonExe get-pip.py --no-warn-script-location
          Remove-Item "get-pip.py"

      - name: Install VoicePerio dependencies
        shell: pwsh
        run: |
          $pythonExe = "VoicePerio_Portable/python/python.exe"
          
          Write-Host "Installing VoicePerio dependencies..."
          & $pythonExe -m pip install --no-warn-script-location `
            "vosk>=0.3.45" `
            "sounddevice>=0.4.6" `
            "pyautogui>=0.9.54" `
            "pynput>=1.7.6" `
            "PyQt6>=6.5.0" `
            "numpy>=1.24.0" `
            "keyboard>=0.13.5" `
            "pywin32>=306" `
            "rapidfuzz>=3.2.0" `
            "jsonschema>=4.19.0" `
            "colorlog>=6.7.0"

      - name: Run pywin32 post-install
        shell: pwsh
        run: |
          $pythonExe = "VoicePerio_Portable/python/python.exe"
          $postInstall = "VoicePerio_Portable/python/Scripts/pywin32_postinstall.py"
          if (Test-Path $postInstall) {
            Write-Host "Running pywin32 post-install (required for win32gui/win32api to work)..."
            & $pythonExe $postInstall -install
            if ($LASTEXITCODE -ne 0) {
              Write-Error "pywin32 post-install failed"
              exit 1
            }
            Write-Host "pywin32 post-install complete"
          } else {
            Write-Error "pywin32_postinstall.py not found at $postInstall - win32gui will fail to import"
            exit 1
          }

      - name: Download Vosk speech model
        shell: pwsh
        run: |
          $modelUrl = "https://alphacephei.com/vosk/models/vosk-model-small-en-us-0.15.zip"
          $modelsDir = "VoicePerio_Portable/models"
          
          Write-Host "Downloading Vosk speech model (~40MB)..."
          Invoke-WebRequest -Uri $modelUrl -OutFile "vosk-model.zip"
          
          Write-Host "Extracting model..."
          Expand-Archive -Path "vosk-model.zip" -DestinationPath $modelsDir -Force
          Remove-Item "vosk-model.zip"
          
          # Rename to standard name (the zip extracts as vosk-model-small-en-us-0.15)
          $extracted = Get-ChildItem $modelsDir -Directory | Select-Object -First 1
          if ($extracted.Name -ne "vosk-model-small-en-us") {
            Rename-Item $extracted.FullName "vosk-model-small-en-us"
          }
          
          Write-Host "Model installed at: $modelsDir/vosk-model-small-en-us"

      - name: Copy VoicePerio application files
        shell: pwsh
        run: |
          $outDir = "VoicePerio_Portable"
          
          # Copy source code
          Copy-Item -Path "src" -Destination "$outDir/app/src" -Recurse
          
          # Copy default commands if at root level
          if (Test-Path "default_commands.json") {
            Copy-Item "default_commands.json" "$outDir/app/"
          }
          
          # Copy download script for future model updates
          if (Test-Path "download_model.py") {
            Copy-Item "download_model.py" "$outDir/app/"
          }
          
          # Copy logo
          if (Test-Path "VoicePerio.png") {
            Copy-Item "VoicePerio.png" "$outDir/app/"
          }
          
          # Copy the launcher
          Copy-Item "VoicePerio_Launch.bat" "$outDir/"
          
          # Copy instructions
          if (Test-Path "USB_INSTRUCTIONS.md") {
            Copy-Item "USB_INSTRUCTIONS.md" "$outDir/"
          } else {
            Write-Warning "USB_INSTRUCTIONS.md not found - skipping"
          }

      - name: Create final zip
        shell: pwsh
        run: |
          Write-Host "Creating VoicePerio_Portable.zip..."
          Compress-Archive -Path "VoicePerio_Portable" -DestinationPath "VoicePerio_Portable.zip" -CompressionLevel Optimal
          
          $size = (Get-Item "VoicePerio_Portable.zip").Length / 1MB
          Write-Host "Bundle size: $([math]::Round($size, 1)) MB"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: VoicePerio_Portable
          path: VoicePerio_Portable.zip
          retention-days: 30
